url: ~
template:
  bootstrap: 5
  light-switch: true
  includes:
    after_body: |
      <script type="module">
      // Pinned Mermaid (v10) for stable rendering on pkgdown site only.
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.esm.min.mjs?v=1091';
      window.mermaid = mermaid;

      (function initMermaid() {
        const SELECTORS = [
          // Common pandoc/pkgdown shapes
          'pre code.language-mermaid',
          'div.sourceCode pre code.language-mermaid',
          'pre code.mermaid',
          'div.sourceCode pre code.mermaid',
          // In case you already have these
          'pre.mermaid',
          'code.mermaid',
          'div.mermaid'
        ];

        function getTheme() {
          // pkgdown light switch uses Bootstrap color mode (data-bs-theme on <html>)
          const bsTheme = document.documentElement.getAttribute('data-bs-theme');
          if (bsTheme === 'dark') return 'dark';
          // 'light' or unset -> neutral (clean print-like)
          return 'neutral';
        }

        function toMermaidDiv(el) {
          // If it's already a mermaid container, mark and skip
          if (el.classList && el.classList.contains('mermaid')) {
            el.dataset.mermaidProcessed = '1';
            return;
          }

          // Otherwise: convert code/pre into a .mermaid div
          const code = el.matches('code') ? el : el.querySelector('code') || el;
          const pre  = code.closest('pre') || code;

          const src = (code.textContent || code.innerText || '').trim();
          if (!src) return;

          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = src;
          div.dataset.mermaidProcessed = '1';

          pre.replaceWith(div);
        }

        function collectTargets() {
          const found = new Set();
          SELECTORS.forEach(sel => {
            document.querySelectorAll(sel).forEach(n => found.add(n));
          });

          // Convert any unprocessed nodes into .mermaid containers
          found.forEach(n => {
            if (n.dataset && n.dataset.mermaidProcessed === '1') return;
            toMermaidDiv(n);
          });

          return Array.from(document.querySelectorAll('.mermaid'));
        }

        async function render(theme) {
          const containers = collectTargets();
          if (!containers.length) return;

          // Clear any existing SVG so theme changes actually apply
          containers.forEach(d => {
            d.removeAttribute('data-mermaid-rendered');
            // If it already contains an SVG, replace with original source
            const src = d.dataset.mermaidSrc || d.textContent;
            d.dataset.mermaidSrc = src;
            d.textContent = src;
          });

          mermaid.initialize({
            startOnLoad: false,
            theme: theme,
            securityLevel: 'strict'
          });

          try {
            if (typeof mermaid.run === 'function') {
              await mermaid.run({ nodes: containers });
            } else if (typeof mermaid.init === 'function') {
              mermaid.init(undefined, containers);
            }
            containers.forEach(d => { d.dataset.mermaidRendered = '1'; });
          } catch (e) {
            console.error('[pkgdown] Mermaid render failed:', e);
          }
        }

        function renderCurrentTheme() {
          const theme = getTheme();
          // Avoid redundant rerenders
          if (window.__bifrost_mermaid_theme__ === theme) return;
          window.__bifrost_mermaid_theme__ = theme;
          render(theme);
        }

        // Initial render
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', renderCurrentTheme);
        } else {
          renderCurrentTheme();
        }

        // Re-render if user toggles the pkgdown light switch
        const obs = new MutationObserver(() => renderCurrentTheme());
        obs.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['data-bs-theme']
        });
      })();
      </script>
